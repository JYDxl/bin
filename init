#!/usr/bin/ruby

#sudo gem update --system
#sudo gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/
#sudo gem install colorize

require 'colorize'
require 'socket'

def warn
  system "echo 'bin/init mysql|mysql5|canal|mariadb|postgresql|rabbitmq|redis|mongodb|elasticsearch|kibana|cerebro|clickhouse|clickhouse-cluster|kafka|kafka-cluster|nacos|zipkin|sentinel|seata|nginx|minio|alpine|ubuntu|debian|java|env'"
end

# TODO jenkins

def exec(cmd)
  #noinspection RubyResolve
  puts "#{"==>".blue.bold} #{cmd.red.bold}"
  system cmd
end

#noinspection RubyNilAnalysis
ip  = Socket.ip_address_list.detect { |x| x.ipv4_private? }.ip_address
app = ARGV[0]
warn && exit unless app

case app
  when 'mysql'
    exec 'docker build -t mysql-server ~/bin/module/mysql/'
    exec 'docker rm -f mysql-server'
    exec "docker run -d --net backend --name mysql-server -p 3306:3306 -v ~/volume/mysql:/var/lib/mysql -v /home:/extra/home --privileged=true mysql-server --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --lower_case_table_names=1 --default-time_zone='+8:00'"
  when 'mysql5'
    exec 'docker build -t mysql5-server ~/bin/module/mysql5/'
    exec 'docker rm -f mysql5-server'
    exec "docker run -d --net backend --name mysql5-server -p 3307:3306 -v ~/volume/mysql5:/var/lib/mysql -v /home:/extra/home --privileged=true mysql5-server --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --lower_case_table_names=1 --default-time_zone='+8:00'"
  when 'canal'
    exec 'docker build -t canal-server ~/bin/module/canal/'
    exec 'docker rm -f canal-server'
    exec "docker run -d --net backend --name canal-server -p 11111:11111 -v /home:/extra/home --privileged=true canal-server"
  when 'mariadb'
    exec 'docker build -t mariadb-server ~/bin/module/mariadb/'
    exec 'docker rm -f mariadb-server'
    exec "docker run -d --net backend --name mariadb-server -p 3308:3306 -v ~/volume/maria:/var/lib/mysql -v /home:/extra/home -v /etc/localtime:/etc/localtime --privileged=true mariadb-server --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --lower_case_table_names=1 --default-time_zone='+8:00'"
  when 'postgresql'
    exec 'docker build -t postgresql-server ~/bin/module/postgresql/'
    exec 'docker rm -f postgresql-server'
    exec 'docker run -d --net backend --name postgresql-server -p 5432:5432 -v ~/volume/pgdata:/var/lib/postgresql/data -v /home:/extra/home --privileged=true postgresql-server'
  when 'rabbitmq'
    exec 'docker build -t rabbitmq-server ~/bin/module/rabbitmq/'
    exec 'docker rm -f rabbitmq-server'
    exec 'docker run -d --net backend --name rabbitmq-server -p 15672:15672 -p 5672:5672 -v ~/volume/rabbitmq:/var/lib/rabbitmq -v /home:/extra/home --hostname rabbitmq-server --privileged=true rabbitmq-server'
  when 'redis'
    exec 'docker build -t redis-server ~/bin/module/redis/'
    exec 'docker rm -f redis-server'
    exec 'docker run -d --net backend --name redis-server -p 6379:6379 -v ~/volume/redis:/data -v /home:/extra/home --privileged=true redis-server --requirepass "XLrootJYD713"'
  when 'mongodb'
    exec 'docker build -t mongodb-server ~/bin/module/mongodb/'
    exec 'docker rm -f mongodb-server'
    exec 'docker run -d --net backend --name mongodb-server -p 27017:27017 -v ~/volume/mongo:/data/db -v /home:/extra/home --privileged=true mongodb-server'
  when 'elasticsearch'
    exec 'docker build -t elasticsearch-server ~/bin/module/elasticsearch/'
    exec 'docker rm -f elasticsearch-server'
    exec 'docker run -d --net backend --name elasticsearch-server -p 9200:9200 -p 9300:9300 -v ~/volume/elasticsearch:/usr/share/elasticsearch/data -v /home:/extra/home -e "discovery.type=single-node" --privileged=true elasticsearch-server'
  when 'kibana'
    exec 'docker rm -f kibana-server'
    exec 'docker run -d --net backend --name kibana-server -p 5601:5601 -v /home:/extra/home -e "ELASTICSEARCH_HOSTS=http://elasticsearch-server:9200" -e "I18N_LOCALE=zh-CN" --privileged=true docker.elastic.co/kibana/kibana:7.14.0'
  when 'cerebro'
    exec 'docker rm -f cerebro-server'
    exec 'docker run -d --net backend --name cerebro-server -p 9000:9000 -v /home:/extra/home --privileged=true lmenezes/cerebro'
  when 'clickhouse'
    exec 'docker build -t clickhouse-server ~/bin/module/clickhouse/'
    exec 'docker rm -f clickhouse-server'
    exec 'docker run -d --net backend --name clickhouse-server --ulimit nofile=262144:262144 -p 8123:8123 -p 8999:9000 -v ~/volume/clickhouse:/var/lib/clickhouse -v /etc/localtime:/etc/localtime -v /home:/extra/home --privileged=true clickhouse-server'
  when 'clickhouse-cluster'
    exec 'docker build -t clickhouse-shard1-replica1 --build-arg NODE="01-1" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard1-replica2 --build-arg NODE="01-2" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard2-replica1 --build-arg NODE="02-1" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard2-replica2 --build-arg NODE="02-2" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard3-replica1 --build-arg NODE="03-1" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard3-replica2 --build-arg NODE="03-2" ~/bin/module/clickhouse/cluster/'

    path = "~/bin/module/clickhouse/clickhouse-cluster"
    exec "docker-compose -f #{path}/docker-compose.yml down"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'kafka'
    exec "docker build -t kafka-server --build-arg IP='#{ip}' ~/bin/module/kafka/"
    exec 'docker rm -f kafka-server'

    exec 'docker rm -f zookeeper-kafka'
    exec 'docker run -d --net backend --name zookeeper-kafka -p 2181:2181 -v /etc/localtime:/etc/localtime --privileged=true zookeeper:3.6.3'
    sleep 30

    exec 'docker run -d --net backend --name kafka-server -p 9092:9092 -v /etc/localtime:/etc/localtime --log-driver json-file --log-opt max-size=100m --log-opt max-file=2 kafka-server'
  when 'kafka-cluster'
    path = "~/bin/module/kafka/kafka-cluster"
    exec "IP=#{ip} docker-compose -f #{path}/docker-compose.yml down"
    exec "IP=#{ip} docker-compose -f #{path}/docker-compose.yml up -d"
  when 'nacos'
    exec 'docker build -t nacos-server ~/bin/module/nacos/'
    exec 'docker rm -f nacos-server'
    exec 'docker run -d --net backend --name nacos-server -p 8848:8848 -v /home:/extra/home --privileged=true nacos-server'
  when 'zipkin'
    exec 'docker build -t zipkin-server ~/bin/module/zipkin/'
    exec 'docker rm -f zipkin-server'
    exec 'docker run -d --net backend --name zipkin-server -p 9411:9411 -v /etc/localtime:/etc/localtime -v /home:/extra/home --privileged=true zipkin-server --link rabbitmq'
  when 'sentinel'
    exec 'docker build -t sentinel-server ~/bin/module/sentinel/'
    exec 'docker rm -f sentinel-server'
    exec 'docker run -d --net host    --name sentinel-server -v /etc/localtime:/etc/localtime -v /home:/extra/home --privileged=true sentinel-server'
  when 'nginx'
    exec 'docker build -t nginx-server ~/bin/module/nginx/'
    exec 'docker rm -f nginx-server'
    exec 'docker run -d --net backend --name nginx-server -p 80:80 -v ~/frontend:/frontend -v /home:/extra/home --privileged=true nginx-server'
  when 'minio'
    exec 'docker build -t minio-server ~/bin/module/minio/'
    exec 'docker rm -f minio-server'
    exec 'docker run -d --net backend --name minio-server -p 8998:9000 -p 8997:8997 -v ~/volume/minio:/data -v ~/config/minio:/root/.minio -v /home:/extra/home -v /etc/localtime:/etc/localtime --privileged=true minio-server server /data --console-address ":8997"'
  when 'seata'
    exec "docker build -t seata-server --build-arg IP='#{ip}' ~/bin/module/seata/"
    exec 'docker rm -f seata-server'
    exec 'docker run -d --net backend --name seata-server -p 8091:8091 -v /etc/localtime:/etc/localtime -v /home:/extra/home --privileged=true seata-server'
  when 'alpine'
    exec 'docker build -t alpine-os ~/bin/module/alpine/'
    exec 'docker rm -f alpine-os'
    exec 'docker run -d --net backend --name alpine-os -v /home:/extra/home -it alpine-os sh'
  when 'ubuntu'
    exec 'docker build -t ubuntu-os ~/bin/module/ubuntu/'
    exec 'docker rm -f ubuntu-os'
    exec 'docker run -d --net backend --name ubuntu-os -v /etc/localtime:/etc/localtime -v /home:/extra/home -it ubuntu-os /bin/bash'
  when 'debian'
    exec 'docker build -t debian-os ~/bin/module/debian/'
    exec 'docker rm -f debian-os'
    exec 'docker run -d --net backend --name debian-os -v /home:/extra/home -it debian-os /bin/bash'
  when 'java'
    exec 'docker build -t jre-alpine ~/bin/module/java/'
  when 'env'
    exec 'docker network create backend'
  else
    warn
end
