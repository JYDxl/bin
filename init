#!/usr/bin/ruby

#sudo gem update --system
#sudo gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/
#sudo gem install colorize

require 'colorize'
require 'socket'
require 'etc'

def warn
  system "echo 'bin/init mysql|canal|mariadb|postgresql|rabbitmq|redis-sentinel|redis-cluster|mongodb-cluster|neo4j|elasticsearch-cluster|logstash|kibana|cerebro|clickhouse-cluster|flink-cluster|kafka-cluster|nacos-cluster|zipkin|sentinel|seata|nginx|minio|alpine|ubuntu|debian|env'"
end

# TODO jenkins

def exec(cmd)
  #noinspection RubyResolve
  puts "#{"==>".blue.bold} #{cmd.red.bold}"
  system cmd
end

#noinspection RubyNilAnalysis
ip  = Socket.ip_address_list.detect { |x| x.ipv4_private? }.ip_address
num = Etc.nprocessors
app = ARGV[0]
warn && exit unless app

case app
  when 'mysql'
    exec 'docker build -t mysql-server ~/bin/module/mysql/'
    exec 'docker rm -f mysql-server'
    exec "docker run -d --net backend --name mysql-server -p 3306:3306 -v /opt/volumes/mysql:/var/lib/mysql -v /opt/volumes/extra:/extra mysql-server --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --lower_case_table_names=1 --default-time_zone='+8:00'"
  when 'canal'
    exec 'docker build -t canal-server ~/bin/module/canal/'
    exec 'docker rm -f canal-server'
    exec "docker run -d --net backend --name canal-server -p 11111:11111 -v /opt/volumes/extra:/extra canal-server"
  when 'mariadb'
    exec 'docker build -t mariadb-server ~/bin/module/mariadb/'
    exec 'docker rm -f mariadb-server'
    exec "docker run -d --net backend --name mariadb-server -p 3308:3306 -v /opt/volumes/maria:/var/lib/mysql -v /opt/volumes/extra:/extra -v /etc/localtime:/etc/localtime mariadb-server --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --lower_case_table_names=1 --default-time_zone='+8:00'"
  when 'postgresql'
    exec 'docker build -t postgresql-server ~/bin/module/postgresql/'
    exec 'docker rm -f postgresql-server'
    exec 'docker run -d --net backend --name postgresql-server -p 5432:5432 -v /opt/volumes/pgdata:/var/lib/postgresql/data -v /opt/volumes/extra:/extra postgresql-server'
  when 'rabbitmq'
    exec 'docker build -t rabbitmq-server ~/bin/module/rabbitmq/'
    exec 'docker rm -f rabbitmq-server'
    exec 'docker run -d --net backend --name rabbitmq-server -p 15672:15672 -p 5672:5672 -v /opt/volumes/rabbitmq:/var/lib/rabbitmq -v /opt/volumes/extra:/extra --hostname rabbitmq-server rabbitmq-server'
  when 'redis'
    exec 'docker build -t redis-server ~/bin/module/redis/'
    exec 'docker rm -f redis-server'
    exec 'docker run -d --net backend --name redis-server -p 6379:6379 -v /opt/volumes/redis:/data -v /opt/volumes/extra:/extra redis-server --requirepass "XLrootJYD713"'
  when 'neo4j'
    exec 'docker build -t neo4j-server ~/bin/module/neo4j'

    path = "~/bin/module/neo4j"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'redis-sentinel'
    path = "~/bin/module/redis/redis-sentinel"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'redis-cluster'
    path = "~//bin/module/redis/redis-cluster"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'mongodb-cluster'
    path = "~/bin/module/mongodb/mongodb-cluster"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'elasticsearch-cluster'
    path = "~/bin/module/elasticsearch/elasticsearch-cluster"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'logstash'
    exec 'docker build -t logstash-server ~/bin/module/logstash/'
    exec 'docker rm -f logstash-server'
    exec "docker run -d --net backend --name logstash-server -v /opt/volumes/extra:/extra logstash-server"
  when 'kibana'
    exec 'docker rm -f kibana-server'
    exec 'docker run -d --net backend --name kibana-server -p 5601:5601 -v /opt/volumes/extra:/extra -e "ELASTICSEARCH_HOSTS=http://elasticsearch-server:9200" -e "I18N_LOCALE=zh-CN" docker.elastic.co/kibana/kibana:7.14.0'
  when 'cerebro'
    exec 'docker rm -f cerebro-server'
    exec 'docker run -d --net backend --name cerebro-server -p 9000:9000 -v /opt/volumes/extra:/extra lmenezes/cerebro'
  when 'clickhouse-cluster'
    exec 'docker build -t clickhouse-shard0-replica0 --build-arg NODE="00-0" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard0-replica1 --build-arg NODE="00-1" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard1-replica0 --build-arg NODE="01-0" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard1-replica1 --build-arg NODE="01-1" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard2-replica0 --build-arg NODE="02-0" ~/bin/module/clickhouse/cluster/'
    exec 'docker build -t clickhouse-shard3-replica1 --build-arg NODE="02-1" ~/bin/module/clickhouse/cluster/'

    path = "~/bin/module/clickhouse/clickhouse-cluster"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'flink-cluster'
    path = "~/bin/module/flink/flink-cluster"
    exec "NUM=#{num} docker-compose -f #{path}/docker-compose.yml down -v"
    exec "NUM=#{num} docker-compose -f #{path}/docker-compose.yml up -d"
  when 'kafka-cluster'
    path = "~/bin/module/kafka/kafka-cluster"
    exec "IP=#{ip} docker-compose -f #{path}/docker-compose.yml down -v"
    exec "IP=#{ip} docker-compose -f #{path}/docker-compose.yml up -d"
  when 'nacos-cluster'
    path = "~/bin/module/nacos/nacos-cluster"
    exec "docker-compose -f #{path}/docker-compose.yml down -v"
    exec "docker-compose -f #{path}/docker-compose.yml up -d"
  when 'zipkin'
    exec 'docker build -t zipkin-server ~/bin/module/zipkin/'
    exec 'docker rm -f zipkin-server'
    exec 'docker run -d --net backend --name zipkin-server -p 9411:9411 -v /etc/localtime:/etc/localtime -v /opt/volumes/extra:/extra zipkin-server --link rabbitmq'
  when 'sentinel'
    exec 'docker build -t sentinel-server ~/bin/module/sentinel/'
    exec 'docker rm -f sentinel-server'
    exec 'docker run -d --net host    --name sentinel-server -v /etc/localtime:/etc/localtime -v /opt/volumes/extra:/extra sentinel-server'
  when 'nginx'
    exec 'docker build -t nginx-server ~/bin/module/nginx/'
    exec 'docker rm -f nginx-server'
    exec 'docker run -d --net backend --name nginx-server -p 80:80 -v ~/frontend:/frontend -v /opt/volumes/extra:/extra nginx-server'
  when 'minio'
    exec 'docker build -t minio-server ~/bin/module/minio/'
    exec 'docker rm -f minio-server'
    exec 'docker run -d --net backend --name minio-server -p 8998:9000 -p 8997:8997 -v /opt/volumes/minio:/data -v ~/config/minio:/root/.minio -v /opt/volumes/extra:/extra -v /etc/localtime:/etc/localtime minio-server server /data --console-address ":8997"'
  when 'seata'
    exec "docker build -t seata-server --build-arg IP='#{ip}' ~/bin/module/seata/"
    exec 'docker rm -f seata-server'
    exec 'docker run -d --net backend --name seata-server -p 8091:8091 -v /etc/localtime:/etc/localtime -v /opt/volumes/extra:/extra seata-server'
  when 'alpine'
    exec 'docker build -t alpine-os ~/bin/module/alpine/'
    exec 'docker rm -f alpine-os'
    exec 'docker run -d --net backend --name alpine-os -v /opt/volumes/extra:/extra -it alpine-os sh'
  when 'ubuntu'
    exec 'docker build -t ubuntu-os ~/bin/module/ubuntu/'
    exec 'docker rm -f ubuntu-os'
    exec 'docker run -d --net backend --name ubuntu-os -v /etc/localtime:/etc/localtime -v /opt/volumes/extra:/extra -it ubuntu-os /bin/bash'
  when 'debian'
    exec 'docker build -t debian-os ~/bin/module/debian/'
    exec 'docker rm -f debian-os'
    exec 'docker run -d --net backend --name debian-os -v /opt/volumes/extra:/extra -it debian-os /bin/bash'
  when 'env'
    exec 'docker network create backend'
  else
    warn
end
